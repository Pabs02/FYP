{% extends 'base.html' %}
{% block content %}
<div class="container">
	<div class="row justify-content-center">
		<div class="col-md-8">
			<h2 class="mb-4">ğŸ“ Canvas LMS Sync</h2>
			
			<!-- Flash Messages -->
			{% with messages = get_flashed_messages(with_categories=true) %}
				{% if messages %}
					{% for category, message in messages %}
						<div class="alert alert-{{ 'success' if category=='success' else ('warning' if category=='warning' else 'danger') }} alert-dismissible fade show" role="alert">
							{{ message }}
							<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						</div>
					{% endfor %}
				{% endif %}
			{% endwith %}
			
			<!-- Canvas Token Status -->
			<div class="card mb-4">
				<div class="card-header {{ 'bg-success' if has_token else 'bg-warning' }} text-white">
					<h5 class="mb-0">
						{% if has_token %}
							âœ… Canvas API Token Configured
						{% else %}
							âš ï¸ Canvas API Token Not Set
						{% endif %}
					</h5>
				</div>
				<div class="card-body">
					{% if has_token %}
						<p class="mb-0">
							<strong>Status:</strong> Ready to sync assignments from Canvas<br>
							<strong>Canvas Instance:</strong> UCC Canvas (ucc.instructure.com)
						</p>
					{% else %}
						<div class="alert alert-warning mb-3">
							<strong>âš ï¸ Setup Required</strong><br>
							You need to add your Canvas API token before you can sync assignments.
						</div>
						
						<h6>How to Get Your Canvas API Token:</h6>
						<ol>
							<li>Go to <a href="https://ucc.instructure.com" target="_blank">UCC Canvas</a></li>
							<li>Click <strong>Account</strong> â†’ <strong>Settings</strong></li>
							<li>Scroll to <strong>Approved Integrations</strong></li>
							<li>Click <strong>+ New Access Token</strong></li>
							<li>Give it a name (e.g., "Student Planner")</li>
							<li>Copy the token</li>
						</ol>
						
						<h6>Add Your Token to Database:</h6>
						<p>Run this in Supabase SQL Editor:</p>
						<pre class="bg-light p-3 rounded"><code>UPDATE students 
SET canvas_api_token = 'YOUR_TOKEN_HERE'
WHERE id = {{ current_user.id }};</code></pre>
						
						<p class="text-muted mt-3">
							<small>âš ï¸ Note: Store your token securely. Never share it or commit it to version control.</small>
						</p>
					{% endif %}
				</div>
			</div>
			
			<!-- Sync Statistics -->
			<div class="card mb-4">
				<div class="card-header bg-info text-white">
					<h5 class="mb-0">ğŸ“Š Sync Statistics</h5>
				</div>
				<div class="card-body">
					<div class="row text-center">
						<div class="col-md-6">
							<h2 class="text-primary">{{ canvas_tasks }}</h2>
							<p class="text-muted">Canvas Assignments Synced</p>
						</div>
						<div class="col-md-6">
							<h2 class="text-success">{{ total_tasks }}</h2>
							<p class="text-muted">Total Tasks</p>
						</div>
					</div>
					
					{% if canvas_tasks > 0 %}
						<div class="alert alert-info mt-3">
							<strong>â„¹ï¸ Last Sync:</strong> You have {{ canvas_tasks }} assignment(s) imported from Canvas.
							Click "Sync Now" to update with any new assignments or changes.
						</div>
					{% endif %}
				</div>
			</div>
			
			<!-- Sync Button -->
			{% if has_token %}
				<div class="card">
					<div class="card-body text-center">
						<h5 class="mb-3">Ready to Sync Your Assignments?</h5>
						<p class="text-muted mb-4">
							This will import all your upcoming assignments from Canvas LMS,<br>
							including due dates, course codes, and assignment titles.
						</p>
						
						<form method="POST" action="{{ url_for('sync_canvas') }}">
							<button type="submit" class="btn btn-primary btn-lg">
								<i class="bi bi-cloud-download"></i> ğŸ”„ Sync Canvas Assignments
							</button>
						</form>
						
						<p class="text-muted mt-3">
							<small>
								This will:
								<ul class="list-unstyled">
									<li>âœ… Fetch all active courses</li>
									<li>âœ… Import upcoming assignments</li>
									<li>âœ… Create modules for each course</li>
									<li>âœ… Update existing assignments</li>
									<li>âœ… Skip assignments without due dates</li>
								</ul>
							</small>
						</p>
					</div>
				</div>
			{% else %}
				<div class="alert alert-warning text-center">
					<h5>âš ï¸ Cannot Sync Without Canvas Token</h5>
					<p>Please follow the instructions above to add your Canvas API token.</p>
				</div>
			{% endif %}
			
			<!-- Back to Dashboard -->
			<div class="text-center mt-4">
				<a href="{{ url_for('index') }}" class="btn btn-outline-secondary">â† Back to Dashboard</a>
				<a href="{{ url_for('tasks') }}" class="btn btn-outline-primary">View Tasks â†’</a>
			</div>
		</div>
	</div>
</div>
{% endblock %}

