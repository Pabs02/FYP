{% extends "base.html" %}
{% block title %}Study Groups{% endblock %}
{% block content %}
<style>
	.sg-page { max-width: 1200px; margin: 0 auto; }
	.sg-grid { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; margin-top: 1rem; }
	@media (max-width: 992px) { .sg-grid { grid-template-columns: 1fr; } }
	.sg-card {
		background: #fff;
		border: 1px solid #e2e8f0;
		border-radius: 14px;
		padding: 1rem;
	}
	.sg-list { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.8rem; }
	.sg-link {
		display: block;
		padding: 0.65rem 0.75rem;
		border: 1px solid #e2e8f0;
		border-radius: 10px;
		color: #1f2937;
		text-decoration: none;
		font-weight: 600;
	}
	.sg-link:hover { border-color: #6366f1; color: #4338ca; }
	.sg-link.active { background: #eef2ff; border-color: #6366f1; color: #3730a3; }
	.msg-list { max-height: 420px; overflow-y: auto; }
	.msg-item { border-bottom: 1px solid #f1f5f9; padding: 0.75rem 0; }
	.msg-item:last-child { border-bottom: none; }
	.resource-item { border: 1px solid #e2e8f0; border-radius: 10px; padding: 0.75rem; margin-bottom: 0.6rem; }
</style>

<div class="sg-page">
	<div class="page-header-card">
		<h1>ðŸ‘¥ Study Groups</h1>
		<p>Join module-based groups, share resources, and collaborate with classmates.</p>
		<div class="mt-3">
			<a
				href="https://libcal.ucc.ie/reserve/librarygrouprooms"
				target="_blank"
				rel="noopener noreferrer"
				class="btn btn-sm btn-outline-primary"
			>
				Book UCC Library Group Study Room
			</a>
		</div>
	</div>

	{% with messages = get_flashed_messages(with_categories=true) %}
		{% if messages %}
			<div class="mt-3">
				{% for category, message in messages %}
					<div class="alert {% if category in ['success'] %}alert-success{% elif category in ['warning', 'info'] %}alert-warning{% else %}alert-danger{% endif %} mb-2">
						{{ message }}
					</div>
				{% endfor %}
			</div>
		{% endif %}
	{% endwith %}

	<div class="sg-grid">
		<div class="sg-card">
			<div class="fw-semibold">Your Module Groups</div>
			<p class="small text-muted mb-1">Pick a module to open or create its study group.</p>
			<div class="sg-list">
				{% for code in module_codes %}
					<a class="sg-link {% if code == selected_module_code %}active{% endif %}" href="{{ url_for('study_groups', module_code=code) }}">
						{{ code }}
					</a>
				{% else %}
					<p class="small text-muted mb-0">No module-linked tasks yet. Add module tasks first.</p>
				{% endfor %}
			</div>
		</div>

		<div class="sg-card">
			{% if selected_module_code %}
				<div class="d-flex justify-content-between align-items-center mb-3">
					<div>
						<h5 class="mb-1">{{ selected_module_code }} Study Group</h5>
						<p class="text-muted mb-0 small">{{ member_count }} member{{ '' if member_count == 1 else 's' }}</p>
					</div>
					{% if is_member %}
						<form method="POST" action="{{ url_for('study_groups', module_code=selected_module_code) }}">
							<input type="hidden" name="action" value="leave_group">
							<input type="hidden" name="module_code" value="{{ selected_module_code }}">
							<button type="submit" class="btn btn-sm btn-outline-danger">Leave Group</button>
						</form>
					{% else %}
						<form method="POST" action="{{ url_for('study_groups', module_code=selected_module_code) }}">
							<input type="hidden" name="action" value="join_group">
							<input type="hidden" name="module_code" value="{{ selected_module_code }}">
							<button type="submit" class="btn btn-sm btn-primary">Join Group</button>
						</form>
					{% endif %}
				</div>

				<div class="row g-3">
					<div class="col-lg-7">
						<div class="border rounded p-3 h-100">
							<div class="fw-semibold mb-2">Team Messaging Thread</div>
							{% if is_member %}
								<form method="POST" action="{{ url_for('study_groups', module_code=selected_module_code) }}" class="mb-3">
									<input type="hidden" name="action" value="post_message">
									<input type="hidden" name="module_code" value="{{ selected_module_code }}">
									<textarea class="form-control mb-2" name="message" rows="3" maxlength="1500" placeholder="Share a question, update, or study tip..."></textarea>
									<button type="submit" class="btn btn-sm btn-outline-primary">Post Message</button>
								</form>
							{% else %}
								<p class="small text-muted">Join the group to post messages.</p>
							{% endif %}
							<div class="msg-list">
								{% for msg in messages %}
									<div class="msg-item">
										<div class="d-flex justify-content-between align-items-center">
											<div class="fw-semibold">{{ msg.student_name }}</div>
											<div class="small text-muted">{{ msg.created_at | irish_datetime if msg.created_at else '' }}</div>
										</div>
										<div class="small mt-1">{{ msg.message }}</div>
									</div>
								{% else %}
									<p class="small text-muted mb-0">No messages yet.</p>
								{% endfor %}
							</div>
						</div>
					</div>
					<div class="col-lg-5">
						<div class="border rounded p-3 h-100">
							<div class="fw-semibold mb-2">Shared Resources</div>
							{% if is_member %}
								<form method="POST" action="{{ url_for('study_groups', module_code=selected_module_code) }}" class="mb-3">
									<input type="hidden" name="action" value="add_resource">
									<input type="hidden" name="module_code" value="{{ selected_module_code }}">
									<input type="text" class="form-control mb-2" name="title" maxlength="255" placeholder="Resource title">
									<input type="text" class="form-control mb-2" name="url" maxlength="1000" placeholder="Link (optional)">
									<textarea class="form-control mb-2" name="note" rows="2" maxlength="2000" placeholder="Short note (optional)"></textarea>
									<button type="submit" class="btn btn-sm btn-outline-success">Share Resource</button>
								</form>
							{% else %}
								<p class="small text-muted">Join the group to share resources.</p>
							{% endif %}
							<div>
								{% for item in resources %}
									<div class="resource-item">
										<div class="fw-semibold">{{ item.title }}</div>
										{% if item.url %}
											<div><a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">{{ item.url }}</a></div>
										{% endif %}
										{% if item.note %}
											<div class="small text-muted mt-1">{{ item.note }}</div>
										{% endif %}
										<div class="small text-muted mt-1">{{ item.created_at | irish_datetime if item.created_at else '' }}</div>
									</div>
								{% else %}
									<p class="small text-muted mb-0">No shared resources yet.</p>
								{% endfor %}
							</div>
						</div>
					</div>
				</div>

				<div class="border rounded p-3 mt-3">
					<div class="fw-semibold mb-2">Members</div>
					<div class="row g-2">
						{% for member in members %}
							<div class="col-md-6">
								<div class="small">
									<span class="fw-semibold">{{ member.name }}</span>
									<span class="text-muted"> Â· {{ member.email }}</span>
								</div>
							</div>
						{% else %}
							<p class="small text-muted mb-0">No members yet.</p>
						{% endfor %}
					</div>
				</div>
			{% else %}
				<p class="text-muted mb-0">Select a module from the left to open its study group.</p>
			{% endif %}
		</div>
	</div>
</div>
{% endblock %}
