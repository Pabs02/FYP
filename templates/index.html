{% extends 'base.html' %}
{% block content %}
<div class="dashboard-page">
<div class="p-4 p-lg-5 rounded-4 hero-card page-header-card mb-4">
	<div class="row align-items-center g-4">
		<div class="col-lg-7">
			<div class="d-flex flex-wrap gap-2 mb-3">
				<span class="hero-chip">Smart Student Planner</span>
				<span class="badge text-bg-light border">Canvas-ready</span>
				<span class="badge text-bg-light border">AI support</span>
			</div>
			<h1 class="display-6 hero-title mb-3">Plan, track, and analyse coursework with clarity.</h1>
			<p class="lead text-muted mb-4">Stay on top of deadlines, sync Canvas tasks, and break assignments into microtasks.</p>
			<div class="d-flex gap-2 flex-wrap hero-actions">
				<a class="btn btn-primary" href="/tasks">View Tasks</a>
				<a class="btn btn-success" href="/add-data">‚ûï Add Data</a>
				<a class="btn btn-outline-secondary" href="/analytics">View Analytics</a>
				<a class="btn btn-outline-dark" href="/sync-canvas">Sync Canvas</a>
				<a class="btn btn-outline-dark" href="/debug/db">DB Debug</a>
			</div>
		</div>
		<div class="col-lg-5">
			<div class="hero-meta">
				<h6 class="mb-2">Quick start</h6>
				<p class="small text-muted mb-3">Add your modules and assignments, then jump into the dashboard for progress insights.</p>
				<div class="d-flex flex-wrap gap-2">
					<a class="btn btn-sm btn-outline-primary" href="/semester">Active Semester</a>
					<a class="btn btn-sm btn-outline-primary" href="/calendar">Calendar</a>
					<a class="btn btn-sm btn-outline-primary" href="/ai-workspace">AI Workspace</a>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="card dashboard-card mb-4">
	<div class="card-header d-flex justify-content-between align-items-center">
		<span>üéôÔ∏è Voice Quick Actions</span>
		<span id="voiceStatusHome" class="small text-muted">Ready</span>
	</div>
	<div class="card-body">
		<textarea id="voiceTranscriptHome" class="form-control mb-2" rows="2" placeholder="Try: What is due this week? | Any overdue tasks? | Add revision every Tuesday 6pm to 8pm until May"></textarea>
		<div class="d-flex flex-wrap gap-2 mb-2">
			<button id="voiceCaptureBtnHome" type="button" class="btn btn-sm btn-outline-success">Start Recording</button>
			<button id="voiceCommandBtnHome" type="button" class="btn btn-sm btn-outline-primary">Run Voice Command</button>
		</div>
		<div id="voiceResultHome" class="small text-muted"></div>
	</div>
</div>

<!-- Top Row: Progress Overview + Next Assignments -->
<div class="row g-4 mb-4">
	<div class="col-lg-4 col-md-5">
		<!-- Reference: ChatGPT (OpenAI) - Dashboard Grade Display Copy
		     Date: 2026-01-22
		     Prompt: "I want a clear dashboard label for Canvas grades and a short
		     explanation for the priority ordering. Can you suggest UI wording?"
		     ChatGPT provided the UI copy guidance used in this dashboard section. -->
		<div class="card dashboard-card h-100">
			<div class="card-header">Progress Overview</div>
			<div class="card-body">
				{% if progress %}
					{% set status = progress.status or 'on_track' %}
					<div class="d-flex align-items-center mb-3">
						<span class="badge text-bg-{{ 'success' if status=='on_track' else ('warning' if status=='warning' else 'danger') }} me-2">{{ status.replace('_', ' ')|title }}</span>
						<p class="mb-0 text-muted">Automated health-check</p>
					</div>
					<ul class="list-group list-group-flush">
						<li class="list-group-item d-flex justify-content-between align-items-center">
							Overdue tasks
							<span class="badge text-bg-{{ 'danger' if progress.overdue else 'secondary' }}">{{ progress.overdue }}</span>
						</li>
						<li class="list-group-item d-flex justify-content-between align-items-center">
							Due in 48h
							<span class="badge text-bg-{{ 'warning' if progress.nearly_due else 'secondary' }}">{{ progress.nearly_due }}</span>
						</li>
						<li class="list-group-item d-flex justify-content-between align-items-center">
							Completed this week
							<span class="badge text-bg-success">{{ progress.completed_this_week }}</span>
						</li>
					</ul>
					<p class="small text-muted mt-3 mb-0">Keep pending tasks at zero overdue items to stay on track.</p>
				{% else %}
					<p class="text-muted mb-0">No task data available yet. Add assignments to see your progress.</p>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-lg-8 col-md-7">
		<!-- Reference: ChatGPT (OpenAI) - Canvas Grade Display UI
		     Date: 2026-01-22
		     Prompt: "I want to show the latest Canvas score in the 'Next assignments'
		     cards with a simple label. Can you suggest a concise UI label?"
		     ChatGPT provided the UI label for the grade display. -->
		<div class="card dashboard-card h-100">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Next assignments</span>
				<span class="text-muted small">Prioritised by impact &amp; urgency</span>
			</div>
			<div class="card-body">
				{% if upcoming_cards %}
					<div class="row g-3">
						{% for card in upcoming_cards %}
							<div class="col-xl-4 col-lg-6">
								<div class="border rounded-3 p-3 h-100 d-flex flex-column justify-content-between">
									<div>
										<p class="text-muted mb-1 small">{{ card.module_code or 'Module' }}</p>
										<h6 class="mb-2">{{ card.title }}</h6>
										<p class="mb-2"><span class="badge text-bg-primary">Due in {{ card.time_label }}</span></p>
										<p class="small text-muted mb-2">Priority score: {{ "%.1f"|format(card.priority) }}{% if card.weight %} ¬∑ Weight {{ card.weight }}%{% endif %}</p>
										{% if card.score_text %}
											<p class="small text-success mb-2">Latest result: {{ card.score_text }}</p>
										{% endif %}
									</div>
									<div class="d-flex gap-2 flex-wrap">
										<a class="btn btn-sm btn-outline-secondary" href="{{ url_for('task_detail', task_id=card.id) }}">Plan micro-tasks</a>
										<a class="btn btn-sm btn-outline-primary" href="{{ url_for('ai_workspace') }}">‚ú® AI Workspace</a>
									</div>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<p class="text-muted mb-0">No upcoming assignments found. Add tasks or sync Canvas to populate this list.</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- Bottom Row: Reminders + Quick Connect Lecturers (side by side) -->
<div class="row g-4">
	<div class="col-lg-6 col-md-6">
		<div class="card dashboard-card h-100">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Reminders</span>
				<form method="POST" action="/reminders/clear" class="m-0">
					<button type="submit" class="btn btn-sm btn-outline-danger" {% if not reminders %}disabled{% endif %}>
						Clear All
					</button>
				</form>
			</div>
			<div class="card-body d-flex flex-column">
				{% if reminders %}
					<div class="dashboard-scroll flex-grow-1">
						<ul class="list-group list-group-flush">
							{% for reminder in reminders %}
								<li class="list-group-item px-0">
									<div class="d-flex justify-content-between align-items-start gap-2">
										<div class="flex-grow-1 min-width-0">
											<div class="fw-semibold text-truncate-2">{{ reminder.message }}</div>
											{% if reminder.due_at %}
												<small class="text-muted">Due {{ reminder.due_at | irish_datetime }}</small>
											{% endif %}
										</div>
										<form method="POST" action="/reminders/{{ reminder.id }}/read" class="flex-shrink-0">
											<button type="submit" class="btn btn-sm btn-outline-secondary">Mark read</button>
										</form>
									</div>
								</li>
							{% endfor %}
						</ul>
					</div>
				{% else %}
					<p class="text-muted mb-0">No reminders right now. You're all caught up.</p>
				{% endif %}
			</div>
		</div>
	</div>
	<div class="col-lg-6 col-md-6">
		<div class="card dashboard-card h-100">
			<div class="card-header d-flex justify-content-between align-items-center">
				<span>Quick Connect Lecturers</span>
				<div class="d-flex gap-2">
					{% if lecturers %}
						<button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#composeMessageCollapse" aria-expanded="false" aria-controls="composeMessageCollapse">
							‚úâÔ∏è Compose
						</button>
					{% endif %}
					{% if lecturer_history %}
						<a href="/lecturer-messages" class="btn btn-sm btn-outline-secondary">View All</a>
					{% endif %}
				</div>
			</div>
			<div class="card-body d-flex flex-column">
				{% if lecturers %}
					<!-- Collapsible Compose Form -->
					<div class="collapse {% if lecturer_draft %}show{% endif %}" id="composeMessageCollapse">
						<form method="POST" action="/contact-lecturer" class="mb-3 p-3 bg-light rounded-3">
							<div class="row g-2 mb-2">
								<div class="col-sm-6">
									<label for="lecturer_id" class="form-label small fw-semibold">Lecturer</label>
									<select id="lecturer_id" name="lecturer_id" class="form-select form-select-sm" required>
										<option value="">Select...</option>
										{% for lec in lecturers %}
											<option value="{{ lec.id }}" {% if lecturer_id and lecturer_id|string == lec.id|string %}selected{% endif %}>
												{{ lec.name }}{% if lec.module_code %} ({{ lec.module_code }}){% endif %}
											</option>
										{% endfor %}
									</select>
								</div>
								<div class="col-sm-6">
									<label for="lecturer_subject" class="form-label small fw-semibold">Subject</label>
									<input type="text" id="lecturer_subject" name="subject" class="form-control form-control-sm" placeholder="e.g., Assignment query" value="{{ lecturer_subject or '' }}" required>
								</div>
							</div>
							<div class="mb-2">
								<label for="lecturer_request" class="form-label small fw-semibold">What do you need?</label>
								<textarea id="lecturer_request" name="request_text" class="form-control form-control-sm" rows="2" placeholder="Brief description for AI to draft your message">{{ lecturer_request or '' }}</textarea>
							</div>
							<div class="mb-2">
								<label for="lecturer_message" class="form-label small fw-semibold">Message</label>
								<textarea id="lecturer_message" name="message" class="form-control form-control-sm" rows="3" placeholder="Your message to the lecturer...">{{ lecturer_draft or '' }}</textarea>
							</div>
							<div class="d-flex gap-2">
								<button type="submit" name="action" value="generate" class="btn btn-sm btn-outline-secondary flex-fill">ü§ñ Generate Draft</button>
								<button type="submit" name="action" value="send" class="btn btn-sm btn-primary flex-fill">üì§ Send</button>
							</div>
						</form>
					</div>
					<script>
						const lecturerForm = document.querySelector('form[action="/contact-lecturer"]');
						if (lecturerForm) {
							const messageField = lecturerForm.querySelector('#lecturer_message');
							const requestField = lecturerForm.querySelector('#lecturer_request');
							const subjectField = lecturerForm.querySelector('#lecturer_subject');
							const lecturerField = lecturerForm.querySelector('#lecturer_id');
							lecturerForm.addEventListener('submit', (event) => {
								const submitter = event.submitter;
								if (!submitter) {
									return;
								}
								const isGenerate = submitter.value === 'generate';
								if (messageField) {
									messageField.required = !isGenerate;
								}
								if (requestField) {
									requestField.required = isGenerate;
								}
								if (subjectField) {
									subjectField.required = true;
								}
								if (lecturerField) {
									lecturerField.required = true;
								}
							});
						}
					</script>
					
					<!-- Recent Messages (always visible) -->
					{% if lecturer_history %}
						<div class="flex-grow-1">
							<h6 class="mb-2 small text-muted fw-semibold">Recent Messages</h6>
							<div class="dashboard-scroll">
								<div class="list-group list-group-flush">
									{% for item in lecturer_history[:5] %}
										<div class="list-group-item px-0 py-2 bg-transparent">
											<div class="d-flex justify-content-between align-items-start">
												<div class="min-width-0">
													<div class="fw-semibold small">{{ item.subject }}</div>
													<small class="text-muted">
														To {{ item.lecturer_name or 'Lecturer' }}
														¬∑ {{ item.sent_at | irish_datetime }}
													</small>
												</div>
												<span class="badge {% if item.email_status == 'sent' %}text-bg-success{% else %}text-bg-secondary{% endif %} ms-2">
													{{ item.email_status or 'unknown' }}
												</span>
											</div>
										</div>
									{% endfor %}
								</div>
							</div>
						</div>
					{% else %}
						<div class="text-center text-muted py-4">
							<p class="mb-2">No messages sent yet.</p>
							<p class="small mb-0">Click <strong>Compose</strong> to contact a lecturer.</p>
						</div>
					{% endif %}
				{% else %}
					<div class="text-center py-4">
						<p class="text-muted mb-2">No lecturers configured yet.</p>
						<a class="btn btn-sm btn-outline-primary" href="/add-data">‚ûï Add Lecturers</a>
					</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
</div>
<script>
// Reference: ChatGPT (OpenAI) - Reusable Voice Command Widget (Frontend)
// Date: 2026-02-11
// Prompt: "I need a lightweight browser voice widget that records speech and sends
// transcript to a Flask /voice-command endpoint, then renders result feedback.
// Can you provide a reusable JS pattern?"
// ChatGPT provided the start/stop + fetch/render interaction pattern below.
document.addEventListener('DOMContentLoaded', () => {
	const captureBtn = document.getElementById('voiceCaptureBtnHome');
	const commandBtn = document.getElementById('voiceCommandBtnHome');
	const transcriptEl = document.getElementById('voiceTranscriptHome');
	const statusEl = document.getElementById('voiceStatusHome');
	const resultEl = document.getElementById('voiceResultHome');
	const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
	let recognition = null;
	let isListening = false;

	if (SpeechRecognition) {
		recognition = new SpeechRecognition();
		recognition.lang = 'en-IE';
		recognition.interimResults = true;
		recognition.continuous = false;
		recognition.onstart = () => {
			isListening = true;
			captureBtn.textContent = 'Stop Recording';
			statusEl.textContent = 'Listening...';
		};
		recognition.onresult = (event) => {
			let combined = '';
			for (let i = event.resultIndex; i < event.results.length; i += 1) {
				combined += event.results[i][0].transcript;
			}
			transcriptEl.value = `${transcriptEl.value} ${combined}`.trim();
		};
		recognition.onerror = () => {
			statusEl.textContent = 'Voice input failed.';
		};
		recognition.onend = () => {
			isListening = false;
			captureBtn.textContent = 'Start Recording';
			if (!statusEl.textContent.includes('failed')) statusEl.textContent = 'Ready';
		};
	} else {
		captureBtn.disabled = true;
		statusEl.textContent = 'Speech API not supported in this browser.';
	}

	captureBtn?.addEventListener('click', () => {
		if (!recognition) return;
		if (isListening) recognition.stop();
		else recognition.start();
	});

	commandBtn?.addEventListener('click', async () => {
		const transcript = (transcriptEl.value || '').trim();
		if (!transcript) {
			resultEl.textContent = 'Please add or record a transcript first.';
			return;
		}
		commandBtn.disabled = true;
		commandBtn.textContent = 'Running...';
		resultEl.textContent = 'Running voice command...';
		try {
			const response = await fetch('/voice-command', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ transcript }),
			});
			const data = await response.json();
			if (!response.ok || !data.ok) {
				throw new Error(data.error || 'Voice command failed');
			}
			resultEl.textContent = data.message || 'Voice command completed.';
		} catch (error) {
			resultEl.textContent = `Voice command failed: ${error.message}`;
		} finally {
			commandBtn.disabled = false;
			commandBtn.textContent = 'Run Voice Command';
		}
	});
});
</script>
{% endblock %}
