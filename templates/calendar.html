{% extends "base.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container-fluid">
	<div class="d-flex align-items-center justify-content-between mb-3">
		<h2 class="mb-0">üóìÔ∏è Assignment Calendar</h2>
		<div>
			<a href="/tasks" class="btn btn-outline-secondary">List View</a>
		</div>
	</div>

	<div class="alert alert-info" role="alert" id="noEventsHint" style="display:none;">
		No timed lecture events found. If lectures are on your Canvas calendar:
		<ol class="mb-0">
			<li>Run the SQL in <code>scripts/add_calendar_events_table.sql</code> on Supabase.</li>
			<li>Go to <strong>üéì Canvas Sync</strong> and click <strong>Sync</strong> again.</li>
			<li>Reload this page.</li>
		</ol>
	</div>

	<div id="calendar"></div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const events = {{ events | tojson }};
		const hasTimed = Array.isArray(events) && events.some(e => e && e.allDay === false);
		if (!hasTimed) {
			document.getElementById('noEventsHint').style.display = 'block';
		}
		const calendarEl = document.getElementById('calendar');
		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'timeGridWeek',
			headerToolbar: {
				left: 'prev,next today',
				center: 'title',
				right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
			},
			nowIndicator: true,
			editable: false,
			navLinks: true,
			themeSystem: 'standard',
			expandRows: true,
			fixedWeekCount: false,
			stickyHeaderDates: true,
			handleWindowResize: true,
			windowResizeDelay: 100,
			height: 'auto',
			contentHeight: 'auto',
			
			/* Time grid range/slots */
			slotMinTime: '08:00:00',
			slotMaxTime: '25:00:00',      // show 8am ‚Üí 1am next day
			scrollTime: '08:00:00',
			slotDuration: '00:30:00',
			snapDuration: '00:15:00',
			
			/* Default duration for events without an end (assignments) */
			defaultTimedEventDuration: '01:00:00',
			forceEventDuration: true,
			
			/* Month cell behavior */
			dayMaxEvents: true,
			dayMaxEventRows: 6,
			moreLinkClick: 'popover',
			moreLinkText: 'more',
			dayHeaderFormat: { weekday: 'short' },
			showNonCurrentDates: false,
			fixedWeekCount: false,
			eventOrder: ['start','-allDay','title'],
			eventOrderStrict: true,
			
			/* Prevent overlaps in time grid */
			eventOverlap: false,
			slotEventOverlap: false,
			
			/* Rendering */
			eventDisplay: 'block',
			displayEventTime: true,
			eventTimeFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			events,
			eventDidMount: function(info) {
				const props = info.event.extendedProps || {};
				const status = props.status ? props.status.replace('_',' ') : '';
				const loc = props.location ? ` @ ${props.location}` : '';
				info.el.title = `${info.event.title}${status ? ' - ' + status : ''}${loc}`;
			}
		});
		calendar.render();
	});
</script>

<style>
    #calendar { max-width: 1200px; margin: 0 auto 24px auto; }
    .fc .fc-toolbar-title { font-size: 1.2rem; }
    .fc-daygrid-event { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 2px 0; font-size: 12px; padding: 2px 3px; }
    .fc-timegrid-slot { height: 42px; }
    .fc-timegrid-event { min-height: 32px; }
	.fc-timegrid-event.assignment .fc-event-main { font-weight: 600; }
	/* Hide dates from other months completely */
	.fc-day-other { visibility: hidden; }
	.fc-day-other .fc-daygrid-day-number { display: none; }
</style>
{% endblock %}
