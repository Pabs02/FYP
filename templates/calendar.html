{% extends "base.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container-fluid">
	<div class="d-flex align-items-center justify-content-between mb-3">
		<h2 class="mb-0">üóìÔ∏è Assignment Calendar</h2>
		<div>
			<a href="/tasks" class="btn btn-outline-secondary">List View</a>
		</div>
	</div>

	<div class="alert alert-info" role="alert" id="noEventsHint" style="display:none;">
		No timed lecture events found. If lectures are on your Canvas calendar:
		<ol class="mb-0">
			<li>Run the SQL in <code>scripts/add_calendar_events_table.sql</code> on Supabase.</li>
			<li>Go to <strong>üéì Canvas Sync</strong> and click <strong>Sync</strong> again.</li>
			<li>Reload this page.</li>
		</ol>
	</div>

	<div id="calendar"></div>
</div>

<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const events = {{ events | tojson }};
		console.log('[calendar] events', events);
		const hasTimed = Array.isArray(events) && events.some(e => e && e.allDay === false);
		if (!hasTimed) {
			document.getElementById('noEventsHint').style.display = 'block';
		}
		const calendarEl = document.getElementById('calendar');
		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'dayGridMonth',
			headerToolbar: {
				left: 'prev,next today',
				center: 'title',
				right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
			},
			nowIndicator: true,
			editable: false,
			navLinks: true,
			themeSystem: 'standard',
			eventDisplay: 'block',
			displayEventTime: true,
			eventTimeFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			events,
			eventDidMount: function(info) {
				const props = info.event.extendedProps || {};
				const status = props.status ? props.status.replace('_',' ') : '';
				const loc = props.location ? ` @ ${props.location}` : '';
				info.el.title = `${info.event.title}${status ? ' - ' + status : ''}${loc}`;
			}
		});
		calendar.render();
	});
</script>

<style>
	#calendar { max-width: 1100px; margin: 0 auto 40px auto; }
	.fc .fc-toolbar-title { font-size: 1.25rem; }
</style>
{% endblock %}
