{% extends "base.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container-fluid">
	<div class="d-flex align-items-center justify-content-between mb-3">
		<h2 class="mb-0">üóìÔ∏è Assignment Calendar</h2>
		<div>
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
				‚ûï Add Event
			</button>
			<a href="/tasks" class="btn btn-outline-secondary ms-2">List View</a>
		</div>
	</div>

	<div class="alert alert-info" role="alert" id="noEventsHint" style="display:none;">
		No timed lecture events found. If lectures are on your Canvas calendar:
		<ol class="mb-0">
			<li>Run the SQL in <code>scripts/add_calendar_events_table.sql</code> on Supabase.</li>
			<li>Go to <strong>üéì Canvas Sync</strong> and click <strong>Sync</strong> again.</li>
			<li>Reload this page.</li>
		</ol>
	</div>

	<div id="calendar"></div>

	{% if user_events %}
	<div class="mt-4">
		<h4 class="h5">Upcoming scheduled blocks</h4>
		<div class="table-responsive">
			<table class="table table-sm table-striped align-middle">
				<thead>
					<tr>
						<th>Title</th>
						<th>Start</th>
						<th>End</th>
						<th style="width: 120px;">Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for event in user_events %}
					<tr>
						<td>{{ event.title }}</td>
						<td>{{ event.start_at | irish_datetime }}</td>
						<td>{{ event.end_at | irish_datetime }}</td>
						<td>
							<form method="POST" action="{{ url_for('delete_event', event_id=event.id) }}" onsubmit="return confirm('Delete this event from your calendar?');">
								<button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% endif %}
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addEventModalLabel">‚ûï Add Manual Event</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form method="POST" action="{{ url_for('add_calendar_event') }}">
				<div class="modal-body">
					<div class="mb-3">
						<label for="event_title" class="form-label">Event Title <span class="text-danger">*</span></label>
						<input type="text" class="form-control" id="event_title" name="title" required 
						       placeholder="e.g., Part-time Work, Training Session">
					</div>
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
							<input type="date" class="form-control" id="start_date" name="start_date" required>
						</div>
						<div class="col-md-6 mb-3">
							<label for="start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
							<input type="time" class="form-control" id="start_time" name="start_time" required>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="end_date" class="form-label">End Date <span class="text-danger">*</span></label>
							<input type="date" class="form-control" id="end_date" name="end_date" required>
						</div>
						<div class="col-md-6 mb-3">
							<label for="end_time" class="form-label">End Time <span class="text-danger">*</span></label>
							<input type="time" class="form-control" id="end_time" name="end_time" required>
						</div>
					</div>
					<div class="mb-3">
						<label for="event_location" class="form-label">Location (optional)</label>
						<input type="text" class="form-control" id="event_location" name="location" 
						       placeholder="e.g., Office, Training Centre">
					</div>
					<div class="mb-3">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring" 
							       onchange="toggleRecurrenceFields()">
							<label class="form-check-label" for="is_recurring">
								<strong>Make this recurring weekly</strong> (same day and time each week)
							</label>
						</div>
					</div>
					<div class="mb-3" id="recurrence_fields" style="display: none;">
						<label for="recurrence_end_date" class="form-label">Repeat until <span class="text-danger">*</span></label>
						<input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date">
						<small class="text-muted">If not specified, will repeat for 3 months from start date.</small>
					</div>
					<p class="text-muted small mb-0">Manual events (work, training, etc.) will appear on your calendar alongside assignments and lectures.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add Event</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Reference: FullCalendar.js - JavaScript Event Calendar -->
<!-- https://fullcalendar.io/docs -->
<!-- Using FullCalendar v6.1.15 for interactive calendar display -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script id="calendar-data" type="application/json">{{ events | tojson | safe }}</script>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const dataEl = document.getElementById('calendar-data');
		let calendarEvents = [];
		if (dataEl) {
			try {
				calendarEvents = JSON.parse(dataEl.textContent || '[]');
			} catch (err) {
				console.error('Failed to parse calendar events JSON', err);
				calendarEvents = [];
			}
		}
		const hasTimed = Array.isArray(calendarEvents) && calendarEvents.some(e => e && e.allDay === false);
		if (!hasTimed) {
			document.getElementById('noEventsHint').style.display = 'block';
		}
		// Reference: FullCalendar.js Documentation - Initialization
		// https://fullcalendar.io/docs#toc
		// Configuration based on FullCalendar docs, customized for assignment display
		const calendarEl = document.getElementById('calendar');
		const calendar = new FullCalendar.Calendar(calendarEl, {
			initialView: 'timeGridWeek',
			headerToolbar: {
				left: 'prev,next today',
				center: 'title',
				right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
			},
			nowIndicator: true,
			editable: false,
			navLinks: true,
			themeSystem: 'standard',
			expandRows: true,
			fixedWeekCount: false,
			stickyHeaderDates: true,
			handleWindowResize: true,
			windowResizeDelay: 100,
			height: 'auto',
			contentHeight: 'auto',
			
			/* Time grid range/slots */
			slotMinTime: '08:00:00',
			slotMaxTime: '25:00:00',      // show 8am ‚Üí 1am next day
			scrollTime: '08:00:00',
			slotDuration: '00:30:00',
			snapDuration: '00:15:00',
			
			/* Default duration for events without an end (assignments) */
			defaultTimedEventDuration: '01:00:00',
			forceEventDuration: true,
			
			/* Month cell behavior */
			dayMaxEvents: true,
			dayMaxEventRows: 6,
			moreLinkClick: 'popover',
			moreLinkText: 'more',
			dayHeaderFormat: { weekday: 'short', day: 'numeric' },
			views: {
				// Reference: ChatGPT (OpenAI) - Ordinal Date Formatter
			// Date: 2025-10-30
			// Prompt: "I need a JavaScript function to convert numbers to ordinal format (1st, 2nd, 3rd, 4th, etc.). 
			// It should handle edge cases like 11th, 12th, 13th (which use 'th' not 'st', 'nd', 'rd'). 
			// Can you provide a function that handles all cases correctly?"
			// ChatGPT provided the ordinal function algorithm that correctly handles all number cases including 
			// edge cases like 11th, 12th, 13th, 21st, 22nd, etc.
			// Reference: FullCalendar.js Documentation - Custom Title Format
			// https://fullcalendar.io/docs/titleFormat
			timeGridDay: {
					titleFormat: function(arg) {
						try {
							const date = arg.start;
							if (!date) return '';
							const day = date.getDate();
							const month = date.toLocaleDateString('en-US', { month: 'long' });
							const year = date.getFullYear();
							const ordinal = (n) => {
								const s = ['th', 'st', 'nd', 'rd'];
								const v = n % 100;
								return n + (s[(v - 20) % 10] || s[v] || s[0]);
							};
							return `${month} ${ordinal(day)}, ${year}`;
						} catch (e) {
							return '';
						}
					}
				},
				timeGridWeek: {
					titleFormat: { year: 'numeric', month: 'long', day: 'numeric' }
				},
				dayGridMonth: {
					titleFormat: { year: 'numeric', month: 'long' }
				}
			},
			showNonCurrentDates: false,
			eventOrder: ['start','-allDay','title'],
			eventOrderStrict: true,
			
			/* Prevent overlaps in time grid */
			eventOverlap: false,
			slotEventOverlap: false,
			
			/* Rendering */
			eventDisplay: 'block',
			displayEventTime: true,
			eventTimeFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			events: calendarEvents,
			eventDidMount: function(info) {
				const props = info.event.extendedProps || {};
				const status = props.status ? props.status.replace('_',' ') : '';
				const loc = props.location ? ` @ ${props.location}` : '';
				info.el.title = `${info.event.title}${status ? ' - ' + status : ''}${loc}`;
			}
		});
		calendar.render();
	});
	
	// Toggle recurrence fields visibility
	function toggleRecurrenceFields() {
		const checkbox = document.getElementById('is_recurring');
		const fields = document.getElementById('recurrence_fields');
		if (checkbox && fields) {
			fields.style.display = checkbox.checked ? 'block' : 'none';
			if (!checkbox.checked) {
				document.getElementById('recurrence_end_date').value = '';
			}
		}
	}
</script>

<style>
    #calendar { max-width: 1200px; margin: 0 auto 24px auto; }
    .fc .fc-toolbar-title { font-size: 1.2rem; }
    .fc-daygrid-event { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 2px 0; font-size: 12px; padding: 2px 3px; }
    .fc-timegrid-slot { height: 42px; }
    .fc-timegrid-event { min-height: 32px; }
	.fc-timegrid-event.assignment .fc-event-main { font-weight: 600; }
	/* Hide dates from other months completely */
	.fc-day-other { visibility: hidden; }
	.fc-day-other .fc-daygrid-day-number { display: none; }
</style>
{% endblock %}
