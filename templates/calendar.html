{% extends "base.html" %}

{% block title %}Calendar{% endblock %}

{% block content %}
<div class="container">
	<div class="calendar-header page-header-card d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
		<div class="flex-grow-1">
			<h2 class="mb-1">ğŸ—“ï¸ Assignment Calendar</h2>
			<p class="text-muted mb-0">Plan your weeks with assignments, lectures, and manual blocks.</p>
		</div>
		<div class="d-flex flex-wrap gap-2 page-header-actions">
			<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
				â• Add Event
			</button>
			<button type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#printModal">
				ğŸ–¨ï¸ Print
			</button>
			<button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#exportModal">
				ğŸ“¤ Export
			</button>
			<a href="/tasks" class="btn btn-outline-secondary">List View</a>
		</div>
	</div>

	<div class="card table-card mb-4">
		<div class="card-header d-flex justify-content-between align-items-center">
			<span>ğŸ™ï¸ Voice Quick Actions</span>
			<span id="voiceStatusCalendar" class="small text-muted">Ready</span>
		</div>
		<div class="card-body">
			<textarea id="voiceTranscriptCalendar" class="form-control mb-2" rows="2" placeholder="Try: Open calendar | Open modules | Open module IS4408 | Add lecture revision every Tuesday 6pm to 8pm until May"></textarea>
			<div class="d-flex gap-2 flex-wrap mb-2">
				<button id="voiceCaptureBtnCalendar" type="button" class="btn btn-sm btn-outline-success">Start Recording</button>
				<button id="voiceCommandBtnCalendar" type="button" class="btn btn-sm btn-outline-primary">Run Voice Command</button>
			</div>
			<div id="voiceResultCalendar" class="small text-muted"></div>
		</div>
	</div>

	<div class="alert alert-info" role="alert" id="noEventsHint" style="display:none;">
		No timed lecture events found. If lectures are on your Canvas calendar:
		<ol class="mb-0">
			<li>Run the SQL in <code>scripts/add_calendar_events_table.sql</code> on Supabase.</li>
			<li>Go to <strong>ğŸ“ Canvas Sync</strong> and click <strong>Sync</strong> again.</li>
			<li>Reload this page.</li>
		</ol>
	</div>

	<!-- Print-only header (hidden on screen) -->
	<div class="print-header" id="printHeader">
		<h2>ğŸ—“ï¸ Timetable â€” <span class="print-student-name"></span></h2>
		<p><span class="print-date-range"></span> &nbsp;|&nbsp; <span class="print-generated"></span></p>
	</div>

	<div class="card calendar-card mb-4">
		<div class="card-body p-0">
			<div id="calendar" class="calendar-root"></div>
		</div>
	</div>

	{% if recurring_events %}
	<div class="card table-card mb-4">
		<div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
			<span class="fw-semibold">ğŸ” Recurring Events</span>
			<span class="text-muted small">{{ recurring_events|length }} weekly patterns</span>
		</div>
		<div class="table-responsive">
			<table class="table table-hover table-tasks align-middle">
				<thead>
					<tr>
						<th>Title</th>
						<th>Day</th>
						<th>Time</th>
						<th style="width: 120px;">Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for event in recurring_events %}
					<tr>
						<td>
							<span class="fw-semibold">{{ event.title }}</span>
							<span class="badge bg-secondary ms-2">{{ event.count }} weeks</span>
						</td>
						<td>
							<span class="badge bg-primary">{{ event.day_of_week }}</span>
						</td>
						<td class="text-muted">{{ event.start_time }} â€“ {{ event.end_time }}</td>
						<td>
							<form method="POST" action="{{ url_for('delete_recurring_event', event_id=event.id) }}" onsubmit="return confirm('Delete ALL occurrences of this recurring event?');">
								<button type="submit" class="btn btn-sm btn-outline-danger">Delete All</button>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% endif %}

	{% if user_events %}
	<div class="card table-card">
		<div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
			<span class="fw-semibold">ğŸ“… One-time Events</span>
			<span class="text-muted small">{{ user_events|length }} total</span>
		</div>
		<div class="table-responsive">
			<table class="table table-hover table-tasks align-middle">
				<thead>
					<tr>
						<th>Title</th>
						<th>Start</th>
						<th>End</th>
						<th style="width: 120px;">Actions</th>
					</tr>
				</thead>
				<tbody>
					{% for event in user_events %}
					<tr>
						<td class="fw-semibold">{{ event.title }}</td>
						<td>{{ event.start_at | irish_datetime }}</td>
						<td>{{ event.end_at | irish_datetime }}</td>
						<td>
							<form method="POST" action="{{ url_for('delete_event', event_id=event.id) }}" onsubmit="return confirm('Delete this event from your calendar?');">
								<button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
	{% endif %}
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-labelledby="addEventModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addEventModalLabel">â• Add Manual Event</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form method="POST" action="{{ url_for('add_calendar_event') }}">
				<div class="modal-body">
					<div class="mb-3">
						<label for="event_title" class="form-label">Event Title <span class="text-danger">*</span></label>
						<input type="text" class="form-control" id="event_title" name="title" required 
						       placeholder="e.g., Part-time Work, Training Session">
					</div>
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="start_date" class="form-label">Start Date <span class="text-danger">*</span></label>
							<input type="date" class="form-control" id="start_date" name="start_date" required>
						</div>
						<div class="col-md-6 mb-3">
							<label for="start_time" class="form-label">Start Time <span class="text-danger">*</span></label>
							<input type="time" class="form-control" id="start_time" name="start_time" required>
						</div>
					</div>
					<div class="row">
						<div class="col-md-6 mb-3">
							<label for="end_date" class="form-label">End Date <span class="text-danger">*</span></label>
							<input type="date" class="form-control" id="end_date" name="end_date" required>
						</div>
						<div class="col-md-6 mb-3">
							<label for="end_time" class="form-label">End Time <span class="text-danger">*</span></label>
							<input type="time" class="form-control" id="end_time" name="end_time" required>
						</div>
					</div>
					<div class="mb-3">
						<label for="event_location" class="form-label">Location (optional)</label>
						<input type="text" class="form-control" id="event_location" name="location" 
						       placeholder="e.g., Office, Training Centre">
					</div>
					<div class="mb-3">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" id="is_recurring" name="is_recurring" 
							       onchange="toggleRecurrenceFields()">
							<label class="form-check-label" for="is_recurring">
								<strong>Make this recurring weekly</strong> (same day and time each week)
							</label>
						</div>
					</div>
					<div class="mb-3" id="recurrence_fields" style="display: none;">
						<label for="recurrence_end_date" class="form-label">Repeat until <span class="text-danger">*</span></label>
						<input type="date" class="form-control" id="recurrence_end_date" name="recurrence_end_date">
						<small class="text-muted">If not specified, will repeat for 3 months from start date.</small>
					</div>
					<p class="text-muted small mb-0">Manual events (work, training, etc.) will appear on your calendar alongside assignments and lectures.</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add Event</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Print Timetable Modal -->
<div class="modal fade" id="printModal" tabindex="-1" aria-labelledby="printModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="printModalLabel">ğŸ–¨ï¸ Print Timetable</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="mb-3">
					<label class="form-label fw-semibold">View</label>
					<div class="d-flex gap-2">
						<button class="btn btn-outline-primary flex-fill print-view-btn active" data-view="timeGridWeek" onclick="selectPrintView(this)">Weekly</button>
						<button class="btn btn-outline-primary flex-fill print-view-btn" data-view="dayGridMonth" onclick="selectPrintView(this)">Monthly</button>
					</div>
				</div>
				<div class="mb-3">
					<label class="form-label fw-semibold">Include</label>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="printAssignments" checked>
						<label class="form-check-label" for="printAssignments">ğŸ“‹ Assignments (deadlines)</label>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="printLectures" checked>
						<label class="form-check-label" for="printLectures">ğŸ“š Lectures & Events</label>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="printManual" checked>
						<label class="form-check-label" for="printManual">ğŸ“… Manual Events</label>
					</div>
				</div>
				<div class="alert alert-light border small mb-0">
					<strong>Tip:</strong> The calendar will switch to your selected view before printing. Use your browser's print dialog to choose landscape or portrait orientation.
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<button type="button" class="btn btn-dark" onclick="printTimetable()">ğŸ–¨ï¸ Print Timetable</button>
			</div>
		</div>
	</div>
</div>

<!-- Export Calendar Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exportModalLabel">ğŸ“¤ Export to Google Calendar / Outlook</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p class="text-muted mb-3">Download an ICS file to import your schedule into Google Calendar, Outlook, or Apple Calendar.</p>
				<div class="mb-3">
					<label class="form-label fw-semibold">Include</label>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="exportTasks" checked>
						<label class="form-check-label" for="exportTasks">ğŸ“‹ Assignment Deadlines</label>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="exportEvents" checked>
						<label class="form-check-label" for="exportEvents">ğŸ“š Lectures & Events</label>
					</div>
				</div>
				<div class="alert alert-light border small mb-3">
					<strong>How to import:</strong>
					<ol class="mb-0 ps-3 mt-1">
						<li><strong>Google Calendar:</strong> Settings â†’ Import & Export â†’ Import â†’ select the .ics file</li>
						<li><strong>Outlook:</strong> File â†’ Open & Export â†’ Import â†’ iCalendar (.ics)</li>
						<li><strong>Apple Calendar:</strong> Double-click the .ics file</li>
					</ol>
				</div>
				<div class="mb-3">
					<label class="form-label fw-semibold small text-muted">Or copy subscribe URL:</label>
					<div class="input-group">
						<input type="text" class="form-control form-control-sm" id="icsUrl" readonly
						       value="{{ url_for('export_ics', _external=True) }}">
						<button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyIcsUrl()">Copy</button>
					</div>
					<small class="text-muted">Paste this URL into Google Calendar's "From URL" option to auto-sync.</small>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
				<a id="exportDownloadBtn" href="/export/calendar.ics" class="btn btn-success" onclick="updateExportUrl()">ğŸ“¥ Download .ics</a>
			</div>
		</div>
	</div>
</div>

<script>
	function updateExportUrl() {
		const tasks = document.getElementById('exportTasks').checked;
		const events = document.getElementById('exportEvents').checked;
		const btn = document.getElementById('exportDownloadBtn');
		btn.href = `/export/calendar.ics?include_tasks=${tasks}&include_events=${events}`;
	}
	function copyIcsUrl() {
		const input = document.getElementById('icsUrl');
		input.select();
		navigator.clipboard.writeText(input.value).then(() => {
			const btn = input.nextElementSibling;
			btn.textContent = 'Copied!';
			setTimeout(() => { btn.textContent = 'Copy'; }, 2000);
		});
	}
</script>

<!-- Reference: FullCalendar.js - JavaScript Event Calendar -->
<!-- https://fullcalendar.io/docs -->
<!-- Using FullCalendar v6.1.15 for interactive calendar display -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<script id="calendar-data" type="application/json">{{ events | tojson | safe }}</script>

<script>
	// Reference: ChatGPT (OpenAI) - Reusable Voice Command Widget (Frontend)
	// Date: 2026-02-11
	// Prompt: "I need a lightweight browser voice widget that records speech and sends
	// transcript to a Flask /voice-command endpoint, then renders result feedback.
	// Can you provide a reusable JS pattern?"
	// ChatGPT provided the start/stop + fetch/render interaction pattern below.
	(function initCalendarVoiceWidget() {
		const captureBtn = document.getElementById('voiceCaptureBtnCalendar');
		const commandBtn = document.getElementById('voiceCommandBtnCalendar');
		const transcriptEl = document.getElementById('voiceTranscriptCalendar');
		const statusEl = document.getElementById('voiceStatusCalendar');
		const resultEl = document.getElementById('voiceResultCalendar');
		if (!captureBtn || !commandBtn || !transcriptEl || !statusEl || !resultEl) return;
		const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
		let recognition = null;
		let isListening = false;

		if (SpeechRecognition) {
			recognition = new SpeechRecognition();
			recognition.lang = 'en-IE';
			recognition.interimResults = true;
			recognition.continuous = false;
			recognition.onstart = () => {
				isListening = true;
				captureBtn.textContent = 'Stop Recording';
				statusEl.textContent = 'Listening...';
			};
			recognition.onresult = (event) => {
				let combined = '';
				for (let i = event.resultIndex; i < event.results.length; i += 1) {
					combined += event.results[i][0].transcript;
				}
				transcriptEl.value = `${transcriptEl.value} ${combined}`.trim();
			};
			recognition.onerror = () => { statusEl.textContent = 'Voice input failed.'; };
			recognition.onend = () => {
				isListening = false;
				captureBtn.textContent = 'Start Recording';
				if (!statusEl.textContent.includes('failed')) statusEl.textContent = 'Ready';
			};
		} else {
			captureBtn.disabled = true;
			statusEl.textContent = 'Speech API not supported in this browser.';
		}

		captureBtn.addEventListener('click', () => {
			if (!recognition) return;
			if (isListening) recognition.stop();
			else recognition.start();
		});

		commandBtn.addEventListener('click', async () => {
			const transcript = (transcriptEl.value || '').trim();
			if (!transcript) {
				resultEl.textContent = 'Please add or record a transcript first.';
				return;
			}
			commandBtn.disabled = true;
			commandBtn.textContent = 'Running...';
			resultEl.textContent = 'Running voice command...';
			try {
				const response = await fetch('/voice-command', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ transcript }),
				});
				const data = await response.json();
				if (!response.ok || !data.ok) throw new Error(data.error || 'Voice command failed');
				resultEl.textContent = data.message || 'Voice command completed.';
				if (data.data && data.data.redirect_url) {
					window.location.href = data.data.redirect_url;
					return;
				}
			} catch (error) {
				resultEl.textContent = `Voice command failed: ${error.message}`;
			} finally {
				commandBtn.disabled = false;
				commandBtn.textContent = 'Run Voice Command';
			}
		});
	})();

	document.addEventListener('DOMContentLoaded', function() {
		const dataEl = document.getElementById('calendar-data');
		let calendarEvents = [];
		if (dataEl) {
			try {
				calendarEvents = JSON.parse(dataEl.textContent || '[]');
			} catch (err) {
				console.error('Failed to parse calendar events JSON', err);
				calendarEvents = [];
			}
		}
		// Reference: ChatGPT (OpenAI) - FullCalendar Duplicate Event Dedupe (Client-Side)
		// Date: 2026-02-11
		// Prompt: "My FullCalendar events are sometimes duplicated due to sync/repeat
		// inserts. Can you show a simple JS pattern to dedupe an events array before
		// rendering (based on title/start/end/allDay)?"
		// ChatGPT provided the Set-key dedupe pattern below.
		try {
			const seen = new Set();
			calendarEvents = (calendarEvents || []).filter(e => {
				if (!e) return false;
				const key = `${e.title || ''}|${e.start || ''}|${e.end || ''}|${e.allDay ? '1' : '0'}`;
				if (seen.has(key)) return false;
				seen.add(key);
				return true;
			});
		} catch (e) {
			// keep original list if something goes wrong
		}
		const hasTimed = Array.isArray(calendarEvents) && calendarEvents.some(e => e && e.allDay === false);
		if (!hasTimed) {
			document.getElementById('noEventsHint').style.display = 'block';
		}
		// Reference: FullCalendar.js Documentation - Initialization
		// https://fullcalendar.io/docs#toc
		// Configuration based on FullCalendar docs, customized for assignment display
		const calendarEl = document.getElementById('calendar');
		const calendar = window._fcInstance = new FullCalendar.Calendar(calendarEl, {
			initialView: 'timeGridWeek',
			headerToolbar: {
				left: 'prev,next today',
				center: 'title',
				right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
			},
			nowIndicator: true,
			editable: false,
			navLinks: true,
			themeSystem: 'standard',
			expandRows: true,
			fixedWeekCount: false,
			stickyHeaderDates: true,
			handleWindowResize: true,
			windowResizeDelay: 100,
			height: 'auto',
			contentHeight: 'auto',
			
			/* Time grid range/slots */
			slotMinTime: '08:00:00',
			slotMaxTime: '25:00:00',      // show 8am â†’ 1am next day
			scrollTime: '08:00:00',
			slotDuration: '00:30:00',
			snapDuration: '00:15:00',
			
			/* Default duration for events without an end (assignments) */
			defaultTimedEventDuration: '01:00:00',
			forceEventDuration: true,

			// Reference: ChatGPT (OpenAI) - FullCalendar nextDayThreshold for Late-Night Events
			// Date: 2026-02-11
			// Prompt: "Some events end after midnight (e.g., 6pmâ€“1am) and FullCalendar
			// shows them spilling into the next day in month view. How can I treat
			// events ending before a certain time as still part of the previous day?"
			// ChatGPT recommended using nextDayThreshold to avoid unwanted spillover.
			nextDayThreshold: '02:00:00',
			
			/* Month cell behavior */
			dayMaxEvents: true,
			dayMaxEventRows: 6,
			moreLinkClick: 'popover',
			moreLinkText: 'more',
			dayHeaderFormat: { weekday: 'short', day: 'numeric' },
			views: {
				// Reference: ChatGPT (OpenAI) - Ordinal Date Formatter
			// Date: 2025-10-30
			// Prompt: "I need a JavaScript function to convert numbers to ordinal format (1st, 2nd, 3rd, 4th, etc.). 
			// It should handle edge cases like 11th, 12th, 13th (which use 'th' not 'st', 'nd', 'rd'). 
			// Can you provide a function that handles all cases correctly?"
			// ChatGPT provided the ordinal function algorithm that correctly handles all number cases including 
			// edge cases like 11th, 12th, 13th, 21st, 22nd, etc.
			// Reference: FullCalendar.js Documentation - Custom Title Format
			// https://fullcalendar.io/docs/titleFormat
			timeGridDay: {
					titleFormat: function(arg) {
						try {
							const date = arg.start;
							if (!date) return '';
							const day = date.getDate();
							const month = date.toLocaleDateString('en-US', { month: 'long' });
							const year = date.getFullYear();
							const ordinal = (n) => {
								const s = ['th', 'st', 'nd', 'rd'];
								const v = n % 100;
								return n + (s[(v - 20) % 10] || s[v] || s[0]);
							};
							return `${month} ${ordinal(day)}, ${year}`;
						} catch (e) {
							return '';
						}
					}
				},
				timeGridWeek: {
					titleFormat: { year: 'numeric', month: 'long', day: 'numeric' }
				},
				dayGridMonth: {
					titleFormat: { year: 'numeric', month: 'long' }
				}
			},
			showNonCurrentDates: false,
			eventOrder: ['start','-allDay','title'],
			eventOrderStrict: true,
			
			/* Prevent overlaps in time grid */
			eventOverlap: false,
			slotEventOverlap: false,
			
			/* Rendering */
			eventDisplay: 'block',
			displayEventTime: true,
			eventTimeFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: true, meridiem: 'long' },
			events: calendarEvents,
			eventDidMount: function(info) {
				const props = info.event.extendedProps || {};
				const status = props.status ? props.status.replace('_',' ') : '';
				const loc = props.location ? ` @ ${props.location}` : '';
				info.el.title = `${info.event.title}${status ? ' - ' + status : ''}${loc}`;
			}
		});
		calendar.render();
		_printCalendar = calendar;
	});
	
	// Toggle recurrence fields visibility
	function toggleRecurrenceFields() {
		const checkbox = document.getElementById('is_recurring');
		const fields = document.getElementById('recurrence_fields');
		if (checkbox && fields) {
			fields.style.display = checkbox.checked ? 'block' : 'none';
			if (!checkbox.checked) {
				document.getElementById('recurrence_end_date').value = '';
			}
		}
	}
</script>

<style>
	.calendar-card {
		border: 1px solid #e5e7eb;
		border-radius: 1.25rem;
		box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
		background: #fff;
	}
	.calendar-root {
		padding: 0.75rem 1rem 1.25rem 1rem;
	}
	.fc .fc-toolbar {
		gap: 0.5rem;
		flex-wrap: wrap;
		padding: 0.75rem 0.5rem 0.25rem 0.5rem;
	}
	.fc .fc-toolbar-title {
		font-size: 1.15rem;
		font-weight: 600;
		color: #111827;
	}
	.fc .fc-button {
		border-radius: 999px;
		border: 1px solid #e5e7eb;
		background: #fff;
		color: #111827;
		padding: 0.4rem 0.85rem;
		font-weight: 500;
	}
	.fc .fc-button-primary:not(:disabled):hover,
	.fc .fc-button-primary:not(:disabled):focus {
		background: #111827;
		border-color: #111827;
		color: #fff;
	}
	.fc .fc-button-primary:disabled {
		opacity: 0.6;
	}
	.fc .fc-button-active {
		background: #111827;
		border-color: #111827;
		color: #fff;
	}
	.fc .fc-daygrid-day-frame {
		border-radius: 0.75rem;
	}
	.fc .fc-day-today {
		background: rgba(79, 70, 229, 0.08);
	}
	.fc .fc-daygrid-event,
	.fc .fc-timegrid-event {
		border-radius: 0.6rem;
		font-size: 0.78rem;
		padding: 0.15rem 0.4rem;
	}
	/* Reference: ChatGPT (OpenAI) - FullCalendar Event Text Wrapping
	   Date: 2026-02-11
	   Prompt: "My FullCalendar event titles overflow and look duplicated because
	   they don't wrap. Can you provide CSS to wrap long event text cleanly in both
	   month and week views?"
	   ChatGPT provided the white-space/word-break rules below. */
	.fc .fc-event-title,
	.fc .fc-event-time,
	.fc .fc-event-title-container,
	.fc .fc-event-main {
		white-space: normal !important;
		overflow-wrap: anywhere;
		word-break: break-word;
	}
	.fc .fc-daygrid-event {
		align-items: flex-start;
	}
	.fc .fc-daygrid-event .fc-event-title {
		line-height: 1.15;
	}
	.fc-timegrid-slot {
		height: 40px;
	}
	.fc-timegrid-event {
		min-height: 30px;
	}
	.fc-timegrid-event.assignment .fc-event-main {
		font-weight: 600;
	}
	.fc-theme-standard td,
	.fc-theme-standard th {
		border-color: #e5e7eb;
	}
	.fc .fc-scrollgrid {
		border: 1px solid #e5e7eb;
		border-radius: 1rem;
		overflow: hidden;
	}
	/* Hide dates from other months completely */
	.fc-day-other { visibility: hidden; }
	.fc-day-other .fc-daygrid-day-number { display: none; }

	/* Print view selection buttons */
	.print-view-btn.active {
		background: #111827;
		border-color: #111827;
		color: #fff;
	}

	/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
	   PRINT-FRIENDLY STYLES
	   Reference: ChatGPT (OpenAI) - Print-Friendly Calendar CSS
	   Date: 2026-02-10
	   Prompt: "I need @media print CSS rules to create a clean, printable
	   timetable from my FullCalendar.js calendar. Hide navigation, buttons,
	   modals, and non-essential UI, keep the calendar grid clean with high
	   contrast and a student info header."
	   ChatGPT provided the @media print rules and the print header pattern.
	   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

	/* Print header (hidden on screen, shown on print) */
	.print-header {
		display: none;
	}

	@media print {
		/* Reset page */
		* { box-shadow: none !important; text-shadow: none !important; }

		body {
			padding-top: 0 !important;
			background: #fff !important;
			font-size: 11pt;
		}
		body::before { display: none !important; }

		/* Hide non-essential UI */
		.dynamic-island,
		.page-header-card,
		.page-header-actions,
		#addEventModal,
		#printModal,
		#noEventsHint,
		.table-card,
		.modal-backdrop,
		.island-mobile-toggle,
		.fc-toolbar button,
		.btn,
		form { display: none !important; }

		/* Show print header */
		.print-header {
			display: block !important;
			text-align: center;
			padding: 12px 0 8px;
			border-bottom: 2px solid #111;
			margin-bottom: 12px;
		}
		.print-header h2 {
			font-size: 18pt;
			font-weight: 700;
			margin: 0;
			color: #111 !important;
			background: none !important;
			-webkit-text-fill-color: #111 !important;
		}
		.print-header h2::after { display: none !important; }
		.print-header p {
			margin: 4px 0 0;
			font-size: 10pt;
			color: #555;
		}

		/* Calendar cleanup for print */
		.calendar-card {
			border: none !important;
			border-radius: 0 !important;
			box-shadow: none !important;
		}
		.calendar-root { padding: 0 !important; }

		/* Show toolbar title only (hide buttons) */
		.fc .fc-toolbar {
			padding: 0 !important;
			justify-content: center !important;
		}
		.fc .fc-toolbar-title {
			font-size: 14pt !important;
			font-weight: 700 !important;
			color: #111 !important;
		}
		.fc-toolbar-chunk:first-child,
		.fc-toolbar-chunk:last-child { display: none !important; }

		/* Clean grid */
		.fc .fc-scrollgrid {
			border: 1px solid #333 !important;
			border-radius: 0 !important;
		}
		.fc-theme-standard td,
		.fc-theme-standard th {
			border-color: #999 !important;
		}
		.fc .fc-day-today {
			background: transparent !important;
		}
		.fc .fc-col-header-cell {
			background: #f0f0f0 !important;
			font-weight: 700;
		}

		/* Events: high contrast */
		.fc .fc-daygrid-event,
		.fc .fc-timegrid-event {
			border-radius: 2px !important;
			font-size: 8pt !important;
			color: #000 !important;
			border: 1px solid #666 !important;
		}
		.fc-event-main { color: #000 !important; }

		/* Remove scroll containers */
		.fc-scroller { overflow: visible !important; }
		.fc-scroller-harness { overflow: visible !important; }

		/* Page settings */
		@page {
			margin: 1cm;
			size: landscape;
		}

		/* Container full width */
		.container { max-width: 100% !important; padding: 0 !important; }
	}
</style>

<script>
	/* â”€â”€ Print Timetable Logic â”€â”€ */
	let _printCalendar = null;   /* set after calendar.render() */
	let _selectedPrintView = 'timeGridWeek';

	function selectPrintView(btn) {
		document.querySelectorAll('.print-view-btn').forEach(b => b.classList.remove('active'));
		btn.classList.add('active');
		_selectedPrintView = btn.dataset.view;
	}

	function printTimetable() {
		if (!_printCalendar) return;

		/* Temporarily switch calendar view */
		const currentView = _printCalendar.view.type;
		_printCalendar.changeView(_selectedPrintView);

		/* Filter events based on checkboxes */
		const showAssignments = document.getElementById('printAssignments').checked;
		const showLectures = document.getElementById('printLectures').checked;
		const showManual = document.getElementById('printManual').checked;

		/* Hide/show events by category via CSS class */
		_printCalendar.getEvents().forEach(ev => {
			const title = ev.title || '';
			const color = ev.backgroundColor || '';
			let visible = true;
			if (!showAssignments && (title.startsWith('ğŸ“‹') || title.startsWith('âš ï¸'))) visible = false;
			if (!showLectures && title.startsWith('ğŸ“š')) visible = false;
			if (!showManual && title.startsWith('ğŸ“…')) visible = false;
			ev.setProp('display', visible ? 'auto' : 'none');
		});

		/* Close modal */
		const modal = bootstrap.Modal.getInstance(document.getElementById('printModal'));
		if (modal) modal.hide();

		/* Populate print header */
		const headerEl = document.getElementById('printHeader');
		if (headerEl) {
			const nameEl = headerEl.querySelector('.print-student-name');
			const dateEl = headerEl.querySelector('.print-date-range');
			const genEl = headerEl.querySelector('.print-generated');
			if (nameEl) nameEl.textContent = '{{ current_user.name }}' || 'Student';
			if (dateEl) dateEl.textContent = _printCalendar.view.title || '';
			if (genEl) genEl.textContent = 'Generated: ' + new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' });
		}

		/* Small delay to let view change render, then print */
		setTimeout(function() {
			window.print();

			/* Restore view and show all events after print */
			setTimeout(function() {
				_printCalendar.changeView(currentView);
				_printCalendar.getEvents().forEach(ev => ev.setProp('display', 'auto'));
			}, 500);
		}, 300);
	}
</script>
{% endblock %}
